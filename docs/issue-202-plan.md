# Issue 202 対応計画

## 意図の理解
- Issue #202 は Issue #201 のコードレビュー結果を踏まえ、重要な欠陥と運用上のリスクを解消するための実装計画を作ることが目的。
- 対象範囲は `components/`, `lib/`, `pages/`, `next.config.js`, `package.json` で、特に外部入力の安全性、ビルド時の非同期処理、運用スクリプトの一貫性が焦点。

## 第三者視点の所感（専門家としての判断）
- 現状の改善で TypeScript / lint / テストは既に入っており、Issue #201 の大枠は達成済み。
- ただし、WebMention/Markdown など外部入力を処理する箇所に XSS の「残り火」があり、攻撃経路が成立し得る。
- RSS 生成の非同期処理未待機や `output` スクリプトの不整合は、障害時の原因究明を難しくする運用リスク。
- これらは「機能は動いて見えるが、事故の温床になる」タイプの問題であり、早期修正が合理的。

## 問題点の洗い出し（重要度順）
- Critical: WebMention の HTML 組み立てで未エスケープの外部入力が混在し、XSS の可能性。
- High: RSS 生成の Promise が未待機で、ビルド時に生成失敗が検知されない。
- Medium: Markdown の生 HTML 出力が許可されており、将来の入力経路拡張で即リスク。
- Medium: `network_graph` のインスタンス破棄が無く、長時間利用時のリーク懸念。
- Low: `npm run output` が `next export` を呼ばない可能性。
- Low: OG 画像の相対パスが外部クローラで解決できない可能性。

## リーダブルコードと禅の精神の確認
- 文字列連結で HTML を構築しない（安全・明快・最小化）。
- 非同期処理は「必ず待ち、失敗は明示的に扱う」。
- 小さく分割し、責務が見える名前と関数にする。
- 追加のルールは増やさず、既存の構成に沿って最小限の変更で解決。

## 実装方針（シンプルで分割された方法）
1. WebMention 表示を React 要素で構築し、外部入力は統一のエスケープ関数か安全なレンダリング経路を使う。
2. RSS 生成を build フェーズで確実に待機し、失敗時はビルドを失敗させる。
3. Markdown の生 HTML 出力を見直し、必要最小限の許可に絞る。
4. `network_graph` のクリーンアップ処理を `useEffect` の戻りで実装する。
5. `npm run output` を `next export` に統一し、手順のブレをなくす。
6. OG 画像 URL を `NEXT_PUBLIC_SITE_URL` で正規化する。

## TDD 前提の実装計画
### 1) テストを先に書く（失敗を確認）
- WebMention: 外部入力に `<script>` 等を含めた場合に DOM に挿入されないことを確認するテスト。
- RSS 生成: 失敗時にビルドが落ちることを検証するテスト（または build フックのユニットテスト）。
- Markdown: 生 HTML が出力されない（または許可されたタグのみ出力される）ことを確認するテスト。
- network_graph: アンマウント時に destroy が呼ばれることを確認するテスト。
- `output` スクリプト: `npm run output` が `next export` を実行することを確認するテスト。
- OG 画像: 相対パスが絶対 URL に正規化されることを確認するテスト。

### 2) 失敗の確認
- テストが赤（失敗）になることを確認し、意図した欠陥が再現される状態を記録。

### 3) 実装
- 失敗したテストを順に満たす最小実装を行い、影響範囲を最小化。
- 各変更は小さくコミットし、レビュー容易性を確保。

### 4) 成功の確認
- 該当テストが全て通ることを確認。
- `npm run build` と `npm run output` の実行結果を確認。

## 実施順序（最短距離）
1. WebMention の安全なレンダリング
2. RSS 生成の待機と失敗検知
3. Markdown 生 HTML の制御
4. network_graph のクリーンアップ
5. `output` スクリプトの統一
6. OG 画像の URL 正規化

## 成果物
- 設計とテストの指針をまとめた計画ドキュメント（本ファイル）
